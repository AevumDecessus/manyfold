<% if defined?(kv_tags) && kv_tags %>
  <% tiers = kv_tags.map(&:name).map { |tag| tag.split(":").first }.uniq.sort %>
  <% if @models
       tierunset = tiers.map { |tier|
         reg = ActiveRecord::Base.connection.quote("^" + tier + ":")
         regact = Rails.env.development? ? "REGEXP" : "~"
         [tier, @models.where("(select count(*) from tags join taggings on tags.id=taggings.tag_id where tags.name #{regact} #{reg} and taggings.taggable_id=models.id and taggings.taggable_type='Model')<1").count]
       }.to_h
     end %>
<% end %>
<%= render partial: "tag", collection: tags %>
<% if defined?(kv_tags) && kv_tags %>
  <ul class="list-unstyled">
    <% tiers.each do |tier| %>
      <li>
        <details id="<%= tier %>">
          <summary><%= tier %></summary>
          <%= render partial: "tag", collection: kv_tags.select { |obj| obj.name.match?("^#{tier}:") } %>
          <%- if tierunset && tierunset[tier] > 0 %>
            <%= link_to "unset (#{tierunset[tier]})", (@filters || {}).merge(missingtag: tier), {class: "badge rounded-pill border border-muted text-danger tag"} %>
          <%- end %>
        </details>
      </li>
    <% end %>
  </ul>
<% end %>
<% if defined?(unrelated_tag_count) && unrelated_tag_count > 0 %>
  <p class="small"><%= t ".unrelated_tag_count", count: unrelated_tag_count %></p>
<% end %>
